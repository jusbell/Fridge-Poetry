<!DOCTYPE HTML>
<html lang="en-US">
<head>
	<meta charset="UTF-8">
	<title>Canvas Test</title>
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
</head>
<body>
<script type="text/javascript">

function ColorImage(src) {
	this.canvas = $('<canvas>').appendTo('body').get(0);
	this.ctx = this.canvas.getContext("2d");

	this.img = new Image();
	var me = this;

	this.img.onload = function(){
		me.loadImg(me.img);
	}
	this.img.src = src;
}

ColorImage.prototype = new Image();
ColorImage.prototype.constructor = Image;

ColorImage.prototype.loadImg = function(){
	this.canvas.width = this.img.width;
	this.canvas.height = this.img.height;
	this.ctx.drawImage(this.img, 0, 0);
}

ColorImage.prototype.getImageData = function(){
	this.imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
	this.data = this.imageData.data;
	return this.data;
}

ColorImage.prototype.putImageData = function(){
	this.ctx.putImageData(this.data, 0, 0);
}

ColorImage.prototype.repaint = function(){
	if (this.hasUpdates){
		this.putImageData();
	}
}

ColorImage.prototype.setPixel = function(p){
	this.hasUpdates = true;
	this.data[p.index] = p.red;
	this.data[p.index+1] = p.green;
	this.data[p.index+2] = p.blue;
	this.data[p.index+3] = p.alpha;
}

ColorImage.prototype.getPixelIterator = function(){
	return new PixelIterator(this.getImageData());
}

function Pixel(data, index){
	this.index = index;
	this.red = data[index];
	this.green = data[index+1];
	this.blue = data[index+2];
	this.alpha = data[index+3];
}

Pixel.prototype.avgColor = function(){
	return (this.red + this.green + this.blue) / 3;
}


function PixelIterator(data){
	this.data = data;
	this.cpos = 0;
}

PixelIterator.prototype = {
	hasNext:function(){
		return this.cpos < this.data.length;
	},
	next:function(){
		var pixel = new Pixel(this.data, this.cpos);
		this.cpos+=4;
		return pixel;
	}
}


function drawImage(){

	var img = new ColorImage('skyline.jpg');

	var iter = img.getPixelIterator();
	while (iter.hasNext()){
		var pixel = iter.next();
		pixel.red = 0;
		pixel.green = 0;
		pixel.blue = 0;
		img.setPixel(pixel);
	}
	img.repaint();
	
	// var imageData = img.getImageData();
	// var data = imageData.data;
 
	// // to quickly iterate over all pixels, use a for loop like this
	// for (var i = 0; i < data.length; i += 4) {
	// 	var red = data[i]; // red
	// 	var green = data[i + 1]; // green
	// 	var blue = data[i + 2]; // blue

		
	// 	// if (blue > 150){
	// 	// 	data[i] = 0;
	// 	// 	data[i + 1] = 0;
	// 	// 	data[i + 2] = 0;
	// 	// }

	// 	var avg = (red + green + blue) / 3;
	// 	if (blue > avg * 1.3) {
	// 		data[i] = 0;
	// 		data[i + 1] = 0;
	// 		data[i + 2] = 0;
	// 	}
	// }

 //    ctx.putImageData(imageData, 0, 0);
}

</script>
</body>
</html>